## 概述

一般情况下，操作系统会接受各种各样的输入操作，如键盘输入、鼠标输入、触摸输入等，系统驱动会从各个输入设备采集原始数据，并对数据进行处理和转化 ，然交给系统处理。对于Android系统而言输入事件主要包括触摸与按键输入，分别对应了MotionEvent和KeyEvent，同时它们有一个统一的抽象接口InputEvent。


InputManagerService（以下简称IMS）是Android为了处理各种用户输入而抽象的一个系统服务。IMS自身是一个Binder服务，在SystemServer进程启动时被实例化，并注册到ServiceManager中。

IMS的职责有两个

- 通过InputReaderThread不断捕获驱动采集的各种输入事件，并通知InputDispatcherThread
- InputDispatcherThread收到通知后再进行事件派发。

IMS会通过InputManager创建一个EventHub和一个InputReaderThread线程来读取事件。EventHub利用Linux的inotify和epoll机制来监听dev/input目录下的各个输入设备。而InputReaderThread线程则通过loop开启一个循环获取EventHub监听到的输入事件。IMS还会创建一个InputDispatcherThread线程负责派发InputReaderThread捕获到的输入事件。

派发事件的首要任务是找到目标窗口，是由WindowManagerService（简称WMS）完成的。SystemServer在初始化WMS时会将IMS传入到WMS中，WMS主要负责管理窗口。Android系统能够同时支持多个屏幕，每块屏幕被抽象成一个DisplayContent，它内部维护了一个WindowList，用来记录当前屏幕的所有窗口。DisplayContent持有所有窗口的信息，因此可以根据触摸事件位置及窗口属性来确定将事件发送到哪个窗口。

找到目标窗口后就需要将事件交给目标窗口了，由于当前IMS和WMS都是位于SystemServer进程中，而目标窗口则位于APP端的用户进程。所以需要用到进程间通信，Input事件的处理不是使用的Binder，而是使用的Socket（低版本使用的Pipe管道方式）进行进程间通信。最终事件会调用InputChannel的sendMessage函数，通过Socket发送到APP端。

APP端监听消息的手段是将Socket添加到Looper线程的epoll数组中取，一有消息到来Looper就会被唤醒并获取事件。通信信道的打开是伴随WindowInputEventReceiver的创建来完成的。事件到来Looper会找到对应的监听器NativeInputEventReceiver，并调用handleEvent处理事件。之后进一步读取事件并封装成Java对象InputEvent传递个Java层。


[十分钟了解Android触摸事件原理（InputManagerService）](https://www.jianshu.com/p/f05d6b05ba17)


